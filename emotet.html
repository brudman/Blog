<!DOCTYPE html>
<html lang="en">

<head>
  <style>
    .center {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 50%;
    }

    code {
      display: block;
      font-family: Consolas,"courier new";
      color: crimson;
      background-color: #f1f1f1;
      padding: 2px;
      font-size: 105%;
    }
  </style>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Byron's Blog!</title>

  <!-- Bootstrap core CSS -->
  <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom fonts for this template -->
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

  <!-- Custom styles for this template -->
  <link href="css/clean-blog.min.css" rel="stylesheet">

  <link rel="icon" type="image/png" href="img/favicon.ico">

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="about.html">About</a>
          </li>
          <!-- <li class="nav-item">
            <a class="nav-link" href="category.html">By Category</a>
          </li> -->
          <li class="nav-item">
            <a class="nav-link" href="contact.html">Contact</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Page Header -->
  <header class="masthead" style="background-image: url('img/spider_2.jpg')">
    <div class="overlay"></div>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <div class="post-heading">
            <h1>Emotet Analysis in Splunk Attack Range</h1>
            <h2 class="subheading">#Emotet #Splunk #SplunkAttackRangeLocal #Sigma</h2>
            <span class="meta">Posted on March 20, 2021</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Post Content -->
  <article>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <p>Welcome to post number one!  </p>

          <p>Earlier this year the Emotet botnet was taken down, so the IOCs generated by this analysis are not increadibly relavent. I however have been wanting to play around with Splunk's Attack Range for a while now and also wanted to look into Emotet a little more given how prevelant it was last year.</p>

          <p>In this post I will talk about my experience setting up Attack Range, running some Emotet malware in the environment and then create some Splunk searches to analyse the excecution. I am going to end off with turning the analysis into <a href="https://github.com/SigmaHQ/sigma" target="_blank">Sigma</a> rules which could be ingested into different SIEM tools.</p>

          <p><a href="https://github.com/splunk/attack_range" target="_blank">Attack Range</a> is a project created by a couple of awesome researchers located on GitHub. It is capable of spinning up a lab environment in the cloud or locally, with very little effort. At the time of writting this it includes a Windows domain controller, Windows server, Windows workstation, Kali machine, Splunk and a Phantom server. <a href="https://github.com/redcanaryco/atomic-red-team" target="_blank">Atomic Red Team</a> and <a href="https://github.com/mitre/caldera" target="_blank">Caldera</a> are also included to run automated attacks against the environment. This all creates a very slick playground for security research &#128526;.</p>

          <h2 class="section-heading">Attack Range Spin Up</h2>

          <p>I decided to use the <a href="https://github.com/splunk/attack_range_local/" target="_blank">local Attack Range</a> as I have a capable machine and also didn't want to spend any money on cloud infrustructure. I am currently working on a Windows machine and it is recommended to either use Ubuntu or MacOS as the host. I don't want to duel boot my current laptop due to drawbacks I have experienced in the past with duel booting, so wanted to run everything in VirtualBox or VMware. I usually prefer VirtualBox over VMware Player, so gave that a shot first. I gave up after a few hours as the nested virtualization within VirtualBox was not working. The issue I was having was basically the same as <a href="https://forums.virtualbox.org/viewtopic.php?f=1&t=62339" target="_blank">this</a>. I did fiddle with Device Guard and Windows Hypervisor, but no cigar, so I decided to turn to VMware Player.</p>

          <p>The bash script <a href="https://github.com/splunk/attack_range_local/wiki/Ubuntu-18.04-Installation" target="_blank">here</a> takes care of almost everything. I also used <a href="https://julian-wieg.medium.com/splunk-attack-range-in-a-virtualized-ubuntu-guest-vm-guide-c6587f43c15" target="_blank">this article</a> to decide on VM specs. The article mentioned issues with the Ubuntu package for Vagrant, but I did not experience any issues with it. I also don't have enough CPU's to match the spec from that article, but that has also not been a problem yet. In a nut shell these are the steps I followed:</p>

          <ol>
            <li>Install VMware Player on Windows 10 host</li>
            <li>Create Ubuntu 18.04 VM with the following specs:</li>
            <dd> - 16GB RAM</dd>
            <dd> - 150GB disk space</dd>
            <dd> - Virtualization enabled</dd>
            <dd> - 6 CPU Cores</dd>
            <li> Follow the instructions <u><a href="https://github.com/splunk/attack_range_local/wiki/Ubuntu-18.04-Installation" target="_blank">here</a></u></li>
            <li>For my testing I only needed a Windows machine and Splunk server, so disabled the Windows domain controller environment in attack_range_local.conf.</li>
            <li>run: python attack_range_local.py -a build</li>
            <li>&#9749; &#127918; &#127926;</li>
          </ol>

          <h2 class="section-heading">Emotet Time</h2>

          <p>If you would like to read about the history of Emotet I would unbiasedly recommend <a href="https://www.dfir.co.za/2020/11/25/everything-you-wish-your-parents-told-you-about-emotet/" target="_blank">my buddy's post</a> &#128521;. For a deep dive I enjoyed <a href="https://www.bromium.com/wp-content/uploads/2019/07/Bromium-Emotet-Technical-Analysis-Report.pdf" target="_blank">Bromium's report</a>.</p>

          <p>In this analysis I am trying to generate IOC's which can be used to detect the varient of Emotet being looked at. I use only the Sysmon logs to do this. There are also Windows event and Powershell logs forwarded to Splunk, but I did not find much worth writing about from these sources.</p>

          <p>The Emotet malware excecuted was found <a href="https://github.com/jstrosch/malware-samples/tree/master/binaries/emotet/2019/October" target="_blank">here</a>. I randomly chose an excecutable in this file (0c45cf4e32116eae8d73b52c140f5d91a19ee8ea), this is the <a href="https://www.virustotal.com/gui/file/6fa0dd6002d4b4e7ebabefc7f4f90f36fc53069e0cf4e845f683fb087d476e90/detection" target="_blank">VirusTotal</a> page for this file. After disabling Windows Defender and firewalls the file was copied onto the Windows 10 machine.</p>

          </br>

          <img class="img-fluid" src="img/emotet/renamed_hash_emotet.png" alt="">
          <span class="caption text-muted">Emotet malware copied onto Windows host and renamed to "0c45cf4e32116eae8d73b52c140f5d91a19ee8ea.exe"</span>

          <p>After running the excecutable a Windows Defender pop up appears:</p>

          </br>

          <img class="center" src="img/emotet/threat_protection_pop_up.png" alt="">
          <span class="caption text-muted">Windows Defender pop up</span>

          <h2 class="section-heading">Splunk Logs</h2>

          <p>Because the analysis results for this file exist on <a href="https://www.virustotal.com/gui/file/6fa0dd6002d4b4e7ebabefc7f4f90f36fc53069e0cf4e845f683fb087d476e90/detection" target="_blank">VirusTotal</a>, I will try look for some indicators which match findings from there. In particular I am looking at IP's contacted, registry key changes, process and files created and shell commands excecuted.</p>

          <p>To try be systematic I will identify the following using the Splunk logs collected:</p>
          <ol>
            <li>Find which processes started as a result of excecuting the malware</li>
            <li>Check which registry keys where changed</li>
            <li>Search for files created</li>
            <li>Look for outbound connections</li>
          </ol>

          <p>I am not expecting this malware to excecute as it did during the VT analysis due to the takedown, but we should still see a lot of local changes and an outbound connection to a malicious URL.</p>

          <p><u>Processes Started</u></p>

          Splunk search:
          <p><code>index=win EventCode=4688 NewProcessName!="*splunk*" ParentProcessName!="*splunk*" | stats count by _time NewProcessName ParentProcessName Caller_Domain Caller_User_Name CommandLine user</code></p>

          <p>The code 4688 is the event code for <a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4688" target="_blank">the creation of a new process</a>. The results from this search don't immediately give away the series of events, but there are some clues given here. We can see that some of the processes listed have a similar <i>CommandLine</i> field (starting with "--"). </p>

          </br>
          <img class="img-fluid" src="img/emotet/new_process_search.png" alt="">
          <span class="caption text-muted">Splunk search for new processes. Processes involving Splunk have been excluded and the time range has been set to start at the time of malware excecution.</span>

          <p>If we use this information we can guess the following process tree:</p>

          <code style="color: black";>
          <i>
            <li style="list-style-type: none;">C:\Users\vagrant\Desktop\0c45cf4e32116eae8d73b52c140f5d91a19ee8ea.exe
              <ul style="list-style-type: none;">
                <li> <span>&#8627;</span> C:\Windows\SysWOW64\licenseskip.exe
                  <ul style="list-style-type: none;">
                    <li> <span>&#8627;</span> C:\Windows\SysWOW64\yYXCAJq.exe
                      <ul style="list-style-type: none;">
                        <li> <span>&#8627;</span> C:\Windows\SysWOW64\targetsguid.exe </li>
                       </ul>
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
          </i>
          </code>

          <p>I wanted to check what these files were and if they were found on VirusTotal. I used the <a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=90001" target="_blank">event code of 1</a> as it contains file hashes in one of the log fields. The following search returned the MD5's for the files:</p>
          <p><code>index=win EventCode=1 | stats count by process_name MD5</code></p>

          <p>This showed that <i>0c45cf4e32116eae8d73b52c140f5d91a19ee8ea.exe</i> and <i>licenseskip.exe</i> shared the MD5: <a href="https://www.virustotal.com/gui/file/6fa0dd6002d4b4e7ebabefc7f4f90f36fc53069e0cf4e845f683fb087d476e90/detection" target="_blank">F4D1470AF3A7D82560B38558B132D468</a>, while <i>yYXCAJq.exe</i> and <i>targetsguid.exe</i> had the MD5 hash of <a href="https://www.virustotal.com/gui/file/e599e5c1d63d7bb6dba19864c4d4b8fb52d861d4561459843cafffe9ff09f9ad/detection" target="_blank">4AB3923D3437AC180673760F4D4F5189</a>. To confirm that <i>licenseskip.exe</i> created the next two processes listed in the process tree above <a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=90011" target="_blank">event code 11</a> is used. The link to that event code shows that this is a common event code seen during malware drops. Running the following search shows that <i>licenseskip.exe</i> dropped <i>yYXCAJq.exe</i> and in turn <i>targetsguid.exe</i>:</p>

          <p><code>index=win EventCode=11 Image="C:\\Windows\\SysWOW64\\licenseskip.exe" | table _time Image TargetFilename EventDescription</code></p>

          <p>The results of that search confirm that <i>targetsguid.exe</i> was dropped by <i>licenseskip.exe</i>.</p>

          <p><u>Registry Key Changes</u></p>

          <p>The windows event codes <a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventID=4657" target="_blank">4657</a> and <a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=90013" target="_blank">13</a> can be used to look at registry key changes and additions. All the registry keys seem to have been added by the malware (event code 13). The search used to find this was:</p>

          <p><code>index=win EventCode=13 OR EventCode=4657 | search Image="C:\\Users\\vagrant\\Desktop\\0c45cf4e32116eae8d73b52c140f5d91a19ee8ea.exe" OR Image="C:\\Windows\\SysWOW64\\licenseskip.exe" | stats count by _time registry_path registry_value_name RuleName</code></p>

          <p>Another indicator pops up here, the registry key "<i>Recalc.Document.1</i>", something else which is interesting is the MITRE techniques appear as a field in the results. This is due to the MITRE ATT&CK Framework integration into Enterprise Security (ES). I think correlation between the MITRE techniques and some log sources are automatically configured when ES is installed, which is why we are seeing these techniques. I wanted to see which other registry keys were being set based on a search for the MITRE techniques. These were all the registry keys I could link to the malware based on searching for any <i>RuleName</i> which started with a "T".</p>

          </br>
          <img class="img-fluid" src="img/emotet/reg_changes_new.png" alt="">
          <span class="caption text-muted">Registry key additions involving 0c45cf4e32116eae8d73b52c140f5d91a19ee8ea.exe and licenseskip.exe</span>

        </br></br>
          <img class="img-fluid" src="img/emotet/persistance_reg_keys.png" alt="">
          <span class="caption text-muted">Registry key additions to create persistence</span>

          <p>The MITRE techniques which show up in the above image included T1050 and T1031, these were not found on the <a href="https://attack.mitre.org/" target="_blank">Mitre website</a>, but were found <a href="https://attack.mitre.org/docs/training-cti/CTI%20Workshop%20Full%20Slides.pdf" target="_blank">here</a>. From that reference T1050 is setting up persistence by creating a new service and T1031 is modifying an existing service but is also related to persistence. <a href="https://answers.microsoft.com/en-us/insider/forum/insider_wintp-insider_perf-insiderplat_pc/set-startup-types-of-many-services-once-and-for/83c14b73-d885-4ca9-a4a3-a0b33eadb7d3" target="_blank">This forum</a> explains what is going on. By adding a registry key to <i>HKLM\System\CurrentControlSet\Services\</i> a new service is being created and by setting <i>HKLM\System\CurrentControlSet\Services\&lt;service name&gt;\Start</i> to <i>0x00000002</i> it will ensure that the service is automatically started. So from the results we can see the malware is creating persistence for <i>C:\Windows\SysWOW64\licenseskip.exe</i> and <i>C:\Windows\SysWOW64\targetsguid.exe</i>.</p>

          <p><u>Finding a C2</u></p>

          <p>This was easy to find due to the fact that the Windows machine was newly built and was only making outbound connections to the Splunk server. The search I would share with colleagues though would be (including filters for efficiency): </p>

          <p><code>index=win source="XmlWinEventLog:Microsoft-Windows-Sysmon/Operational" direction=outbound app="C:\\Windows\\SysWOW64\\licenseskip.exe" | table _time app DestinationIp DestinationPort</code></p>

          <img class="img-fluid" src="img/emotet/C2.png" alt="">
          <span class="caption text-muted">Outbound connection to Emotet C2</span>

          <p>The IP address 192.241.220.183 and port 8080 are linked to an <a href="https://www.virustotal.com/gui/ip-address/192.241.220.183/detection" target="_blank">Emotet C2 on VirusTotal</a>. The connection to this IP and port were successful, but no further communication was made to the address after initial infection. Something interesting to note is that this IP address did not appear in any of the VirusTotal results for the <i><a href="https://www.virustotal.com/gui/file/6fa0dd6002d4b4e7ebabefc7f4f90f36fc53069e0cf4e845f683fb087d476e90/behavior" target="_blank">licenseskip.exe</a></i> and <i><a href="https://www.virustotal.com/gui/file/e599e5c1d63d7bb6dba19864c4d4b8fb52d861d4561459843cafffe9ff09f9ad/behavior" target="_blank">targetsguid.exe</a></i> files. &#129300;</p>

          <h2 class="section-heading">Titbits for Splunk/Cyber beginners</h2>

          <p>I have used a few Windows event codes in the searches above, but knowing these event codes to find the information mentioned is not necessary. We know that the logs we are looking for are in the <a href="https://github.com/splunk/attack_range#logging" target="_blank"><i>win</i></a> index. Starting from there we could paste in the name of the <i>.exe</i> originally excecuted, this returns a manageable amount of data and we can now look at the fields available for filtering. If there is too much data to handle, I like to duplicate the original search into multiple tabs and then explore the data filtering by adding different fields to the search. This will take longer than knowing or searching for specific event codes, but can also help find juicy information very quickly. In this example we can find the filename <i>licenseskip.exe</i> from the search described, we can then run a similar search for <i>licenseskip.exe</i>. Doing this returns two traffic directions in the <i>direction</i> field and the outbound traffic direction contains only one result. Filtering for this gives the C2 server, in corporate land that kind of information should earn you a firm pat on the back.</p>

          <h2 class="section-heading">Sigma the Findings</h2>

          <p><a href="https://github.com/SigmaHQ/sigma" target="_blank">Sigma</a> is a standard for sharing SIEM searches between different platforms. It uses YAML files to create searches in a generic format which can then be converted into formats recognized by <a href="https://github.com/SigmaHQ/sigma#supported-targets">most SIEM tools and even grep!</a> This makes it an awesome tool for sharing rules in a community or in posts like this. I have created <a href="https://github.com/brudman/sigma_rules/blob/main/emotet_blog.yml" target="_blank">Sigma rules for the findings in this post</a>. To convert this file to searches for a specific SIEM the following command can be run from the Sigma base directory after installing <a href="https://pypi.org/project/sigmatools/" target="_blank">sigmatools</a>: </p>

          <code style="color: black";>python3 tools/sigmac -t &lt;SIEM/target name&gt; -c tools/config/generic/sysmon.yml &lt;path to YAML file&gt;emotet_blog.yml </code>

          <h2 class="section-heading">End</h2>
          <P>If you are still reading this, well done and thank you! I hope you have enjoyed it. If you would like to chat about anything related to the post (or anything else) please reach out on one of the platforms below! I will be checking out BloodHound next, I am interested in what it's excecution looks like in the AttackRange environment. See you soon!</p>
        </div>
      </div>
    </div>
  </article>

  <hr>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
          <ul class="list-inline text-center">
            <li class="list-inline-item">
              <a href="https://twitter.com/ByronRudman">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            <li class="list-inline-item">
              <a href="https://www.linkedin.com/in/byron-rudman-114b2878/">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
            <li class="list-inline-item">
              <a href="https://github.com/brudman">
                <span class="fa-stack fa-lg">
                  <i class="fas fa-circle fa-stack-2x"></i>
                  <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap core JavaScript -->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Custom scripts for this template -->
  <script src="js/clean-blog.min.js"></script>

  </body>

  </html>
